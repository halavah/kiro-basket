# 前端部署 - Vercel

> 本文档介绍如何将团长端和居民端前端应用部署到 Vercel 平台

## 📋 部署概览

Vercel 是专为前端框架优化的部署平台，提供出色的性能和开发体验。我们需要分别部署两个前端应用：

- **团长端**（client-captain）- 团长管理后台
- **居民端**（client-resident）- 居民购物平台

**Vercel 免费版特点**：
- ✅ 自动 HTTPS 和全球 CDN
- ✅ 自动部署（Git Push 触发）
- ✅ 预览部署（每个 PR 自动部署预览）
- ✅ 零配置构建
- ⚠️ 每月 100GB 带宽限制
- ⚠️ 商业项目需要付费版

---

## 1. 准备工作

### 1.1 注册 Vercel 账号

1. 访问 [https://vercel.com/signup](https://vercel.com/signup)
2. 选择 "Continue with GitHub"（推荐）
3. 授权 Vercel 访问你的 GitHub 账号
4. 完成注册

### 1.2 修改前端 API 配置

在部署前，需要修改前端的 API 请求地址，指向 Render 上的后端服务。

#### 团长端配置

编辑 [client-captain/src/api/request.js](../../client-captain/src/api/request.js:6-7)：

```javascript
// 修改前（本地开发）
const service = axios.create({
  baseURL: 'http://localhost:3000/api/captain',
  timeout: 10000
});

// 修改后（生产环境）
const service = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || 'https://你的后端地址.onrender.com/api/captain',
  timeout: 10000
});
```

#### 居民端配置

编辑 [client-resident/src/api/request.js](../../client-resident/src/api/request.js:8)：

```javascript
// 修改前（本地开发）
const request = axios.create({
  baseURL: '/api',
  timeout: 10000
})

// 修改后（生产环境）
const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || 'https://你的后端地址.onrender.com/api',
  timeout: 10000
})
```

### 1.3 创建环境变量文件（推荐）

为了更好地管理不同环境的配置，创建环境变量文件：

**团长端** - 创建 `client-captain/.env.production`：
```env
VITE_API_BASE_URL=https://你的后端地址.onrender.com/api/captain
```

**居民端** - 创建 `client-resident/.env.production`：
```env
VITE_API_BASE_URL=https://你的后端地址.onrender.com/api
```

### 1.4 提交代码到 GitHub

```bash
cd /Volumes/Samsung/software_xare/kiro_basket

# 添加修改
git add client-captain/src/api/request.js
git add client-resident/src/api/request.js
git add client-captain/.env.production
git add client-resident/.env.production

# 提交
git commit -m "配置生产环境 API 地址"

# 推送到 GitHub
git push origin master
```

---

## 2. 部署团长端（client-captain）

### 2.1 导入项目

1. 登录 Vercel Dashboard：[https://vercel.com/dashboard](https://vercel.com/dashboard)

2. 点击 "Add New..." → "Project"

3. 在 "Import Git Repository" 页面：
   - 找到你的 GitHub 仓库（`kiro_basket`）
   - 点击 "Import"

### 2.2 配置项目

在 "Configure Project" 页面填写以下信息：

#### 基本配置
```
Project Name: kiro_basket-captain
（或其他你喜欢的名称）

Framework Preset: Vite
（Vercel 会自动检测）

Root Directory: client-captain
（重要：指定团长端目录）
```

点击 "Root Directory" 右侧的 "Edit" 按钮，选择 `client-captain` 目录。

#### 构建配置

Vercel 会自动填充以下配置（无需修改）：
```
Build Command: npm run build
Output Directory: dist
Install Command: npm install
```

#### 环境变量

点击 "Environment Variables" 展开，添加：

| Name | Value |
|------|-------|
| `VITE_API_BASE_URL` | `https://你的后端地址.onrender.com/api/captain` |

> 注意：替换为你在 Render 上部署的后端地址

### 2.3 开始部署

1. 检查所有配置
2. 点击 "Deploy" 按钮
3. 等待部署完成（约 1-3 分钟）

### 2.4 获取部署 URL

部署成功后，Vercel 会显示：
```
🎉 Congratulations! Your project is live.

https://kiro_basket-captain.vercel.app
```

记录这个 URL，这是团长端的访问地址。

### 2.5 测试团长端

1. 访问部署的 URL
2. ��试登录（使用测试账号：admin / 123456）
3. 检查是否能正常访问 API

---

## 3. 部署居民端（client-resident）

### 3.1 创建新项目

居民端需要单独部署为另一个项目。

1. 返回 Vercel Dashboard

2. 点击 "Add New..." → "Project"

3. 再次选择同一个 GitHub 仓库（`kiro_basket`）

4. 点击 "Import"

### 3.2 配置项目

#### 基本配置
```
Project Name: kiro_basket-resident
（居民端项目名称）

Framework Preset: Vite

Root Directory: client-resident
（重要：选择居民端目录）
```

#### 构建配置

自动配置：
```
Build Command: npm run build
Output Directory: dist
Install Command: npm install
```

#### 环境变量

添加环境变量：

| Name | Value |
|------|-------|
| `VITE_API_BASE_URL` | `https://你的后端地址.onrender.com/api` |

### 3.3 开始部署

1. 点击 "Deploy" 按钮
2. 等待部署完成

### 3.4 获取部署 URL

部署成功后获得居民端访问地址：
```
https://kiro_basket-resident.vercel.app
```

### 3.5 测试居民端

1. 访问部署的 URL
2. 注册新用户或使用测试账号登录
3. 测试购物流程

---

## 4. 配置自定义域名（可选）

如果你有自己的域名，可以绑定到 Vercel 项目。

### 4.1 添加域名

1. 进入项目设置：Settings → Domains

2. 输入你的域名（如 `captain.yourdomain.com`）

3. 点击 "Add"

### 4.2 配置 DNS

根据 Vercel 的提示，在你的域名服务商添加 DNS 记录：

**A 记录**：
```
Type: A
Name: captain
Value: 76.76.21.21
```

**CNAME 记录**（推荐）：
```
Type: CNAME
Name: captain
Value: cname.vercel-dns.com
```

等待 DNS 生效（可能需要几分钟到几小时）。

---

## 5. 自动部署配置

### 5.1 启用自动部署

Vercel 默认启用自动部署，每次推送代码到 GitHub 都会自动触发部署。

**部署流程**：
```
本地修改代码 → git push → GitHub → Vercel 自动检测 → 自动部署
```

### 5.2 分支部署

可以配置不同分支对应不同环境：

1. 进入项目设置：Settings → Git

2. 配置生产分支：
   ```
   Production Branch: master（或 main）
   ```

3. 其他分支推送会创建预览部署

### 5.3 预览部署

每个 Pull Request 都会自动创建预览部署：

- 提交 PR 后，Vercel 会在评论中添加预览链接
- 可以在合并前测试新功能
- 不影响生产环境

---

## 6. 更新后端 CORS 配置

前端部署完成后，需要更新后端的 CORS 配置，允许前端域名访问。

### 6.1 更新 server/app.js

```javascript
const cors = require('cors');

// CORS 配置
const allowedOrigins = [
  'http://localhost:5173',  // 本地团长端
  'http://localhost:5174',  // 本地居民端
  'https://kiro_basket-captain.vercel.app',  // 生产环境团长端
  'https://kiro_basket-resident.vercel.app'  // 生产环境居民端
];

app.use(cors({
  origin: function(origin, callback) {
    // 允许没有 origin 的请求（如 Postman）
    if (!origin) return callback(null, true);

    if (allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true
}));
```

### 6.2 提交并部署

```bash
# 修改后提交代码
git add server/app.js
git commit -m "更新 CORS 配置"
git push origin master

# Render 会自动检测并重新部署后端
```

---

## 7. 环境变量管理

### 7.1 查看环境变量

1. 进入项目设置：Settings → Environment Variables
2. 查看所有已配置的环境变量

### 7.2 修改环境变量

1. 找到要修改的变量
2. 点击 "Edit"
3. 修改值后保存
4. **需要重新部署才能生效**

### 7.3 不同环境的变量

可以为不同环境设置不同的值：

- **Production**: 生产环境
- **Preview**: 预览部署
- **Development**: 开发环境

---

## 8. 性能优化

### 8.1 启用 Gzip 压缩

Vercel 默认启用 Gzip 和 Brotli 压缩，无需配置。

### 8.2 图片优化

使用 Vercel 的 Image Optimization（付费功能）：

```javascript
// 使用 next/image 组件（需要迁移到 Next.js）
import Image from 'next/image'

<Image
  src="/uploads/product.jpg"
  width={500}
  height={500}
  alt="商品图片"
/>
```

### 8.3 配置缓存

在项目根目录创建 `vercel.json`：

```json
{
  "headers": [
    {
      "source": "/assets/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "public, max-age=31536000, immutable"
        }
      ]
    }
  ]
}
```

---

## 9. 监控和分析

### 9.1 查看部署日志

1. 进入项目 Dashboard
2. 点击最新的部署
3. 查看 "Build Logs" 和 "Function Logs"

### 9.2 分析流量

Vercel 提供基础的分析功能：

1. 进入项目 Dashboard
2. 点击 "Analytics" 标签
3. 查看访问量、带宽使用等数据

### 9.3 错误监控

建议集成第三方错误监控服务（如 Sentry）：

```bash
npm install @sentry/vue
```

```javascript
// main.js
import * as Sentry from "@sentry/vue";

Sentry.init({
  app,
  dsn: "your-sentry-dsn",
  environment: import.meta.env.MODE
});
```

---

## 10. 故障排查

### 10.1 构建失败

**查看构建日志**：
- 在部署详情页查看完整的构建日志
- 检查依赖安装是否成功
- 确认 vite.config.js 配置正确

**常见问题**：

```bash
# 问题：找不到模块
解决：检查 package.json 中的依赖

# 问题：构建超时
解决：优化构建脚本或升级到付费版

# 问题：Root Directory 错误
解决：确保选择了正确的子目录
```

### 10.2 运行时错误

**API 请求失败**：
- 检查环境变量 `VITE_API_BASE_URL` 配置
- 确认后端 CORS 配置正确
- 使用浏览器开发者工具查看网络请求

**白屏问题**：
- 检查浏览器控制台错误
- 确认所有资源加载成功
- 检查路由配置

### 10.3 回滚部署

如果新部署出现问题，可以回滚到之前的版本：

1. 进入项目 Dashboard
2. 找到之前的稳定部署
3. 点击右侧的 "..." 菜单
4. 选择 "Promote to Production"

---

## 11. 最佳实践

### 11.1 环境分离

- ✅ 使用环境变量管理不同环境的配置
- ✅ 本地开发使用 `.env.development`
- ✅ 生产环境使用 `.env.production`

### 11.2 版本管理

- ✅ 使用语义化版本号（Semantic Versioning）
- ✅ 为重要版本打 Git Tag
- ✅ 在 package.json 中维护版本号

### 11.3 安全建议

- ✅ 不要在前端代码中暴露敏感信息
- ✅ API 密钥等敏感数据放在后端
- ✅ 使用 HTTPS 确保传输安全
- ✅ 实现 CSRF 防护

### 11.4 性能建议

- ✅ 使用懒加载（Lazy Loading）
- ✅ 代码分割（Code Splitting）
- ✅ 压缩图片资源
- ✅ 使用 CDN 加载第三方库

---

## 12. 部署检查清单

完成前端部署后，检查以下事项：

### 团长端
- [ ] 页面能正常访问
- [ ] 登录功能正常
- [ ] API 请求成功
- [ ] 商品管理功能正常
- [ ] 订单管理功能正常
- [ ] 数据看板显示正常

### 居民端
- [ ] 页面能正常访问
- [ ] 注册/登录功能正常
- [ ] 商品浏览正常
- [ ] 购物车功能正常
- [ ] 下单流程正常
- [ ] 个人中心功能正常

---

## 13. 配置信息汇总

完成部署后，记录以下信息：

```
团长端 URL: https://________________.vercel.app
居民端 URL: https://________________.vercel.app

后端 API: https://________________.onrender.com/api
```

---

## 下一步

前端部署完成后，请继续阅读 [06.部署后验证.md](06.部署后验证.md) 进行完整的功能测试。
