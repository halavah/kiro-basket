# ä½¿ç”¨ Cloudflare ä¿æŠ¤ Render å…è´¹åŸŸå

> æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨ Cloudflare ä¿æŠ¤ Render å…è´¹åˆ†é…çš„åŸŸå

## ğŸ“‹ å½“å‰æƒ…å†µ

- **å›¢é•¿ç«¯**: https://kiro-basket-client-captain.onrender.com
- **å±…æ°‘ç«¯**: https://kiro-basket-client-resident.onrender.com
- **é™åˆ¶**: Render å…è´¹ç‰ˆåªæä¾› 2 ä¸ªå›ºå®šåŸŸåï¼Œæ— æ³•è‡ªå®šä¹‰

## ğŸ›¡ï¸ ä¿æŠ¤æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šCloudflare Workers ä»£ç†ï¼ˆæ¨èï¼‰

é€šè¿‡ Cloudflare Workers åˆ›å»ºä¸€ä¸ªä»£ç†å±‚ï¼Œéšè—çœŸå®çš„ Render åŸŸåã€‚

#### æ­¥éª¤ 1ï¼šæ³¨å†Œ Cloudflare è´¦å·

1. è®¿é—® [https://workers.cloudflare.com](https://workers.cloudflare.com)
2. æ³¨å†Œå…è´¹è´¦å·
3. å…è´¹ç‰ˆæ¯å¤© 100,000 æ¬¡è¯·æ±‚

#### æ­¥éª¤ 2ï¼šåˆ›å»º Workers

**å›¢é•¿ç«¯ Worker**ï¼š
```javascript
// captain-proxy.js
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  const url = new URL(request.url)
  const targetUrl = 'https://kiro-basket-client-captain.onrender.com'

  // æ·»åŠ å®‰å…¨å¤´
  const response = await fetch(targetUrl + url.pathname + url.search, {
    method: request.method,
    headers: request.headers,
    body: request.body
  })

  const newResponse = new Response(response.body, response)

  // æ·»åŠ å®‰å…¨å¤´
  newResponse.headers.set('X-Frame-Options', 'DENY')
  newResponse.headers.set('X-Content-Type-Options', 'nosniff')
  newResponse.headers.set('X-XSS-Protection', '1; mode=block')
  newResponse.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')

  return newResponse
}
```

**å±…æ°‘ç«¯ Worker**ï¼š
```javascript
// resident-proxy.js
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  const url = new URL(request.url)
  const targetUrl = 'https://kiro-basket-client-resident.onrender.com'

  const response = await fetch(targetUrl + url.pathname + url.search, {
    method: request.method,
    headers: request.headers,
    body: request.body
  })

  const newResponse = new Response(response.body, response)

  // æ·»åŠ å®‰å…¨å¤´
  newResponse.headers.set('X-Frame-Options', 'DENY')
  newResponse.headers.set('X-Content-Type-Options', 'nosniff')
  newResponse.headers.set('X-XSS-Protection', '1; mode=block')
  newResponse.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')

  return newResponse
}
```

#### æ­¥éª¤ 3ï¼šéƒ¨ç½² Workers

1. åœ¨ Cloudflare Dashboard ä¸­åˆ›å»º Worker
2. ä¸Šä¼ ä»£ç 
3. è·å– Workers åŸŸåï¼ˆå¦‚ï¼šcaptain-proxy.your-subdomain.workers.devï¼‰

#### æ­¥éª¤ 4ï¼šé…ç½®è‡ªå®šä¹‰åŸŸåï¼ˆéœ€è¦è´­ä¹°åŸŸåï¼‰

å¦‚æœä½ æ„¿æ„è´­ä¹°ä¸€ä¸ªä¾¿å®œåŸŸåï¼ˆå¦‚ .xyz åŸŸåçº¦ $1/å¹´ï¼‰ï¼š

1. åœ¨ Cloudflare ä¸­æ·»åŠ åŸŸå
2. åˆ›å»º DNS è®°å½•ï¼š
   ```
   Type: CNAME
   Name: captain
   Target: captain-proxy.your-subdomain.workers.dev
   TTL: Auto
   ```

   ```
   Type: CNAME
   Name: resident
   Target: resident-proxy.your-subdomain.workers.dev
   TTL: Auto
   ```

### æ–¹æ¡ˆäºŒï¼šCloudflare Page Rules

å¦‚æœä½ æœ‰è‡ªå®šä¹‰åŸŸåï¼Œå¯ä»¥ä½¿ç”¨ Page Rules è§„åˆ™ï¼š

1. åœ¨ Cloudflare ä¸­æ·»åŠ åŸŸå
2. è®¾ç½® DNS æŒ‡å‘ Render
3. åˆ›å»º Page Rulesï¼š

```
kiro-basket.com/* (yourdomain.com)
- Always Online: On
- Security Level: High
- Browser Cache TTL: 4 hours
- Auto Minify: HTML, CSS, JS
```

### æ–¹æ¡ˆä¸‰ï¼šå…è´¹åŸŸå + Cloudflare

ä½¿ç”¨å…è´¹åŸŸåæœåŠ¡ï¼ˆå¦‚ Freenomï¼‰ï¼š

1. æ³¨å†Œå…è´¹åŸŸåï¼ˆ.tk, .ml, .ga ç­‰ï¼‰
2. åœ¨ Cloudflare æ·»åŠ åŸŸå
3. é…ç½®ä»£ç†

```dns
Type: CNAME
Name: captain
Target: kiro-basket-client-captain.onrender.com
Proxy: Enabled (Orange Cloud)

Type: CNAME
Name: resident
Target: kiro-basket-client-resident.onrender.com
Proxy: Enabled (Orange Cloud)
```

## ğŸ”’ Cloudflare å®‰å…¨åŠŸèƒ½é…ç½®

### 1. é˜²ç«å¢™è§„åˆ™

åœ¨ Cloudflare Dashboard â†’ Firewall â†’ Rulesï¼š

```javascript
// é˜»æ­¢æ¶æ„è¯·æ±‚
(http.request.uri.path contains "/admin" and ip.geoip.country ne "CN") or
(http.request.user_agent contains "bot" and not cf.bot_management.score lt 30)

// é™åˆ¶é¢‘ç¹è¯·æ±‚
(http.request.method eq "POST" and cf.threat_score gt 10)
```

### 2. é€Ÿç‡é™åˆ¶

```
URL Pattern: *
Rate limit requests: 120 per 1 minute
```

### 3. Bot Fight Mode

åœ¨ Settings â†’ Bot Management å¯ç”¨ï¼š
- Bot Fight Mode: On
- è¶…çº§æœºå™¨äºº Fight Mode: Onï¼ˆå…è´¹ç‰ˆå¯ç”¨ï¼‰

### 4. å®‰å…¨çº§åˆ«

åœ¨ Security â†’ Settingsï¼š
```
Security Level: High
Challenge Passage: 30 minutes
```

## ğŸ’° æˆæœ¬åˆ†æ

### Cloudflare å…è´¹ç‰ˆé™åˆ¶ï¼š
- Workers: 100,000 è¯·æ±‚/å¤©
- å¸¦å®½: æ— é™åˆ¶
- DDoS ä¿æŠ¤: æ— é™åˆ¶
- SSL: å…è´¹è¯ä¹¦

### æ–¹æ¡ˆå¯¹æ¯”ï¼š

| æ–¹æ¡ˆ | æˆæœ¬ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|-----|------|------|------|
| Workers ä»£ç† | $0 | éšè—çœŸå®åŸŸåï¼Œæ·»åŠ å®‰å…¨å¤´ | éœ€è¦ Workers åŸŸå |
| è´­ä¹°åŸŸå | ~$10/å¹´ | ä¸“ä¸šåŸŸåï¼Œå®Œå…¨æ§åˆ¶ | éœ€è¦èŠ±é’± |
| å…è´¹åŸŸå | $0 | å®Œå…¨å…è´¹ | ç¨³å®šæ€§å·® |

## ğŸš€ å®æ–½å»ºè®®

### å¦‚æœé¢„ç®—å…è®¸ï¼ˆæ¨èï¼‰ï¼š

1. è´­ä¹°ä¸€ä¸ªä¾¿å®œåŸŸåï¼ˆ.xyz åŸŸåçº¦ $1/å¹´ï¼‰
2. ä½¿ç”¨ Cloudflare ä»£ç†
3. é…ç½®å®Œæ•´çš„å®‰å…¨è§„åˆ™

### å¦‚æœé¢„ç®—ç´§å¼ ï¼š

1. ä½¿ç”¨ Cloudflare Workers ä»£ç†
2. åœ¨åº”ç”¨ä¸­æ·»åŠ å®‰å…¨æªæ–½
3. ä½¿ç”¨ Render çš„å†…ç½®å®‰å…¨åŠŸèƒ½

## ğŸ“ éƒ¨ç½²æ­¥éª¤ï¼ˆæ–¹æ¡ˆä¸€ï¼šWorkersï¼‰

### 1. åˆ›å»º Worker è„šæœ¬

åˆ›å»ºæ–‡ä»¶ `workers/captain-proxy.js`ï¼š
```javascript
// æ·»åŠ å®‰å…¨åŠŸèƒ½
const SECURITY_HEADERS = {
  'X-Frame-Options': 'DENY',
  'X-Content-Type-Options': 'nosniff',
  'X-XSS-Protection': '1; mode=block',
  'Referrer-Policy': 'strict-origin-when-cross-origin',
  'Content-Security-Policy': "default-src 'self'"
}

addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  try {
    const url = new URL(request.url)
    const targetUrl = 'https://kiro-basket-client-captain.onrender.com'

    // è¯·æ±‚æ—¥å¿—
    console.log(`Request: ${request.method} ${url.pathname}`)

    const response = await fetch(targetUrl + url.pathname + url.search, {
      method: request.method,
      headers: request.headers,
      body: request.body
    })

    const newResponse = new Response(response.body, {
      status: response.status,
      statusText: response.statusText,
      headers: response.headers
    })

    // æ·»åŠ å®‰å…¨å¤´
    Object.entries(SECURITY_HEADERS).forEach(([key, value]) => {
      newResponse.headers.set(key, value)
    })

    return newResponse

  } catch (error) {
    return new Response('Proxy Error', { status: 500 })
  }
}
```

### 2. éƒ¨ç½²åˆ° Cloudflare

```bash
# å®‰è£… Wrangler CLI
npm install -g wrangler

# ç™»å½•
wrangler login

# éƒ¨ç½²
wrangler deploy captain-proxy.js
```

### 3. æ›´æ–°å‰ç«¯ API é…ç½®

ä¿®æ”¹å‰ç«¯åº”ç”¨ä½¿ç”¨ Workers åŸŸåï¼š

```javascript
// client-captain/src/api/request.js
const service = axios.create({
  baseURL: 'https://captain-proxy.your-subdomain.workers.dev',
  timeout: 10000
});
```

### 4. æµ‹è¯•éªŒè¯

1. è®¿é—® Workers åŸŸå
2. æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„ Network æ ‡ç­¾
3. éªŒè¯å®‰å…¨å¤´æ˜¯å¦æ·»åŠ 
4. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸

## ğŸ” ç›‘æ§å’Œåˆ†æ

### Cloudflare Analytics

1. Dashboard â†’ Analytics & Logs
2. ç›‘æ§æŒ‡æ ‡ï¼š
   - è¯·æ±‚æ•°é‡
   - å¨èƒæ£€æµ‹
   - å¸¦å®½ä½¿ç”¨
   - åœ°ç†åˆ†å¸ƒ

### è‡ªå®šä¹‰æ—¥å¿—ï¼ˆå¯é€‰ï¼‰

åœ¨ Worker ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼š

```javascript
// æ·»åŠ è¯·æ±‚æ—¥å¿—
const logData = {
  timestamp: new Date().toISOString(),
  method: request.method,
  path: url.pathname,
  ip: request.headers.get('CF-Connecting-IP'),
  country: request.cf.country
}

console.log(JSON.stringify(logData))
```

## âœ… éªŒè¯æ¸…å•

éƒ¨ç½²å®ŒæˆåéªŒè¯ï¼š

- [ ] Workers æ­£å¸¸å“åº”
- [ ] æ‰€æœ‰é¡µé¢åŠŸèƒ½æ­£å¸¸
- [ ] API è¯·æ±‚æˆåŠŸ
- [ ] å®‰å…¨å¤´å·²æ·»åŠ 
- [ ] CORS é…ç½®æ­£ç¡®
- [ ] HTTPS æ­£å¸¸å·¥ä½œ
- [ ] é”™è¯¯é¡µé¢å‹å¥½æ˜¾ç¤º

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **CORS é”™è¯¯**
   ```javascript
   // åœ¨ Worker ä¸­å¤„ç† CORS
   if (request.method === 'OPTIONS') {
     return new Response(null, {
       headers: {
         'Access-Control-Allow-Origin': '*',
         'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
         'Access-Control-Allow-Headers': 'Content-Type, Authorization'
       }
     })
   }
   ```

2. **è¯·æ±‚è¶…æ—¶**
   - æ£€æŸ¥ Render æœåŠ¡æ˜¯å¦åœ¨çº¿
   - å¢åŠ  Worker è¶…æ—¶æ—¶é—´

3. **æ€§èƒ½é—®é¢˜**
   - å¯ç”¨ç¼“å­˜
   - ä¼˜åŒ–å›¾ç‰‡èµ„æº
   - ä½¿ç”¨ CDN

## ğŸ“š å‚è€ƒèµ„æº

- [Cloudflare Workers æ–‡æ¡£](https://developers.cloudflare.com/workers/)
- [Cloudflare å®‰å…¨åŠŸèƒ½](https://www.cloudflare.com/security/)
- [Render éƒ¨ç½²æŒ‡å—](04.å‰ç«¯éƒ¨ç½²-Vercel.md)

---

## ä¸‹ä¸€æ­¥

å®Œæˆ Cloudflare é…ç½®åï¼Œè¯·é˜…è¯» [06.éƒ¨ç½²åéªŒè¯.md](06.éƒ¨ç½²åéªŒè¯.md) è¿›è¡Œå®Œæ•´çš„åŠŸèƒ½æµ‹è¯•ã€‚