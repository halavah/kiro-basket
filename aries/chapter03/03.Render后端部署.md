# åç«¯éƒ¨ç½² - Render

> æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•å°† Node.js åç«¯æœåŠ¡éƒ¨ç½²åˆ° Render å¹³å°

## ğŸ“‹ éƒ¨ç½²æ¦‚è§ˆ

Render æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„äº‘å¹³å°ï¼Œæä¾›å…è´¹çš„ Web Service æ‰˜ç®¡ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Render éƒ¨ç½²åç«¯ API æœåŠ¡ã€‚

**Render å…è´¹ç‰ˆç‰¹ç‚¹**ï¼š
- âœ… è‡ªåŠ¨ HTTPS
- âœ… è‡ªåŠ¨éƒ¨ç½²ï¼ˆGit Push è§¦å‘ï¼‰
- âœ… å…¨æ‰˜ç®¡ç¯å¢ƒ
- âš ï¸ 15 åˆ†é’Ÿæ— æ´»åŠ¨åæœåŠ¡ä¼‘çœ 
- âš ï¸ æ¯æœˆ 750 å°æ—¶å…è´¹è¿è¡Œæ—¶é—´

---

## 1. å‡†å¤‡å·¥ä½œ

### 1.1 æ³¨å†Œ Render è´¦å·

1. è®¿é—® [https://render.com/](https://render.com/)
2. ç‚¹å‡»å³ä¸Šè§’ "Get Started"
3. ä½¿ç”¨ GitHub è´¦å·æ³¨å†Œï¼ˆæ¨èï¼‰æˆ–ä½¿ç”¨é‚®ç®±æ³¨å†Œ
4. å®Œæˆé‚®ç®±éªŒè¯

### 1.2 å°†ä»£ç æ¨é€åˆ° GitHub

ç¡®ä¿ä½ çš„é¡¹ç›®ä»£ç å·²ç»æ¨é€åˆ° GitHubï¼š

```bash
# å¦‚æœè¿˜æ²¡æœ‰æ¨é€åˆ° GitHubï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤
cd /Volumes/Samsung/software_xare/kiro_basket

# åˆå§‹åŒ– Gitï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
git init

# æ·»åŠ è¿œç¨‹ä»“åº“ï¼ˆæ›¿æ¢ä¸ºä½ çš„ GitHub ä»“åº“åœ°å€ï¼‰
git remote add origin https://github.com/ä½ çš„ç”¨æˆ·å/kiro_basket.git

# æäº¤ä»£ç 
git add .
git commit -m "Prepare for deployment"

# æ¨é€åˆ° GitHub
git push -u origin master
```

### 1.3 æ£€æŸ¥é¡¹ç›®ç»“æ„

ç¡®ä¿ `server/package.json` ä¸­æœ‰æ­£ç¡®çš„å¯åŠ¨è„šæœ¬ï¼š

```json
{
  "name": "community-group-buying-server",
  "version": "1.0.0",
  "scripts": {
    "start": "node app.js",
    "dev": "nodemon app.js"
  },
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "express": "^4.18.2",
    "jsonwebtoken": "^9.0.2",
    "mongoose": "^8.0.3",
    "multer": "^1.4.5-lts.1",
    "mysql2": "^3.6.5",
    "sequelize": "^6.35.1"
  }
}
```

---

## 2. åœ¨ Render åˆ›å»º Web Service

### 2.1 åˆ›å»ºæ–°æœåŠ¡

1. ç™»å½• Renderï¼Œè¿›å…¥ Dashboard

2. ç‚¹å‡» "New +" æŒ‰é’®ï¼Œé€‰æ‹© **"Web Service"**

3. è¿æ¥ GitHub ä»“åº“ï¼š
   - å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œç‚¹å‡» "Connect GitHub"
   - æˆæƒ Render è®¿é—®ä½ çš„ GitHub ä»“åº“
   - é€‰æ‹©ä½ çš„é¡¹ç›®ä»“åº“ï¼ˆå¦‚ `kiro_basket`ï¼‰

### 2.2 é…ç½®æœåŠ¡

åœ¨åˆ›å»ºæœåŠ¡é¡µé¢å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š

#### åŸºæœ¬ä¿¡æ¯
```
Name: kiro_basket-api
ï¼ˆæˆ–å…¶ä»–ä½ å–œæ¬¢çš„åç§°ï¼Œè¿™å°†æˆä¸ºæœåŠ¡çš„å­åŸŸåï¼‰

Region: Singaporeï¼ˆæˆ–é€‰æ‹©ç¦»ä½ æœ€è¿‘çš„åŒºåŸŸï¼‰

Branch: masterï¼ˆæˆ– mainï¼Œå–å†³äºä½ çš„é»˜è®¤åˆ†æ”¯åï¼‰

Root Directory: server
ï¼ˆé‡è¦ï¼šå› ä¸ºåç«¯ä»£ç åœ¨ server ç›®å½•ä¸‹ï¼‰
```

#### è¿è¡Œæ—¶é…ç½®
```
Runtime: Node

Build Command: npm install
ï¼ˆRender ä¼šè‡ªåŠ¨è¿è¡Œè¿™ä¸ªå‘½ä»¤å®‰è£…ä¾èµ–ï¼‰

Start Command: npm start
ï¼ˆæˆ– node app.jsï¼‰
```

#### å®ä¾‹ç±»å‹
```
Instance Type: Free
ï¼ˆé€‰æ‹©å…è´¹ç‰ˆï¼‰
```

### 2.3 é…ç½®ç¯å¢ƒå˜é‡

å‘ä¸‹æ»šåŠ¨åˆ° **"Environment Variables"** éƒ¨åˆ†ï¼Œæ·»åŠ ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

ç‚¹å‡» "Add Environment Variable"ï¼Œé€ä¸ªæ·»åŠ ï¼š

| Key | Value | è¯´æ˜ |
|-----|-------|------|
| `NODE_ENV` | `production` | è¿è¡Œç¯å¢ƒ |
| `PORT` | `3000` | ç«¯å£å· |
| `MYSQL_HOST` | `db4free.net` | MySQL ä¸»æœº |
| `MYSQL_PORT` | `3306` | MySQL ç«¯å£ |
| `MYSQL_USER` | `ä½ çš„MySQLç”¨æˆ·å` | ä»ä¸Šä¸€æ­¥è·å– |
| `MYSQL_PASSWORD` | `ä½ çš„MySQLå¯†ç ` | ä»ä¸Šä¸€æ­¥è·å– |
| `MYSQL_DATABASE` | `ä½ çš„æ•°æ®åº“å` | ä»ä¸Šä¸€æ­¥è·å– |
| `MONGODB_URI` | `ä½ çš„MongoDBè¿æ¥å­—ç¬¦ä¸²` | ä»ä¸Šä¸€æ­¥è·å– |
| `JWT_SECRET` | `ç”Ÿäº§ç¯å¢ƒå¯†é’¥` | å»ºè®®ç”Ÿæˆéšæœºå­—ç¬¦ä¸² |
| `JWT_EXPIRES_IN` | `7d` | Token è¿‡æœŸæ—¶é—´ |
| `MAX_FILE_SIZE` | `10` | æ–‡ä»¶ä¸Šä¼ é™åˆ¶ï¼ˆMBï¼‰ |
| `API_PREFIX` | `/api` | API è·¯å¾„å‰ç¼€ |

#### ç”Ÿæˆå®‰å…¨çš„ JWT_SECRET

åœ¨æœ¬åœ°ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆéšæœºå¯†é’¥ï¼š

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ Node.js
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"

# æ–¹æ³• 2ï¼šä½¿ç”¨ openssl
openssl rand -hex 64
```

å°†ç”Ÿæˆçš„éšæœºå­—ç¬¦ä¸²ä½œä¸º `JWT_SECRET` çš„å€¼ã€‚

### 2.4 åˆ›å»ºæœåŠ¡

1. æ£€æŸ¥æ‰€æœ‰é…ç½®ä¿¡æ¯
2. ç‚¹å‡»åº•éƒ¨çš„ **"Create Web Service"** æŒ‰é’®
3. Render å¼€å§‹æ„å»ºå’Œéƒ¨ç½²æœåŠ¡ï¼ˆçº¦éœ€ 3-5 åˆ†é’Ÿï¼‰

---

## 3. éƒ¨ç½²è¿‡ç¨‹

### 3.1 æ„å»ºæ—¥å¿—

éƒ¨ç½²å¼€å§‹åï¼Œä½ ä¼šçœ‹åˆ°å®æ—¶æ„å»ºæ—¥å¿—ï¼š

```
==> Cloning from https://github.com/ä½ çš„ç”¨æˆ·å/kiro_basket...
==> Checking out commit xxxxx
==> Building...
==> Running 'npm install'
==> Successfully installed dependencies
==> Running 'npm start'
==> Server is running on port 3000
==> Your service is live ğŸ‰
```

### 3.2 è·å–æœåŠ¡ URL

éƒ¨ç½²æˆåŠŸåï¼ŒRender ä¼šåˆ†é…ä¸€ä¸ª URLï¼š

```
https://kiro_basket-api.onrender.com
```

è®°å½•è¿™ä¸ª URLï¼Œç¨åé…ç½®å‰ç«¯æ—¶ä¼šç”¨åˆ°ã€‚

### 3.3 æµ‹è¯• API

åœ¨æµè§ˆå™¨æˆ–ä½¿ç”¨ curl æµ‹è¯•å¥åº·æ£€æŸ¥æ¥å£ï¼š

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl https://kiro_basket-api.onrender.com/health

# åº”è¯¥è¿”å›
{
  "status": "ok",
  "timestamp": "2025-12-19T10:30:00.000Z"
}
```

---

## 4. é…ç½® CORS

ä¸ºäº†è®©å‰ç«¯èƒ½å¤Ÿè®¿é—®åç«¯ APIï¼Œéœ€è¦ç¡®ä¿ CORS é…ç½®æ­£ç¡®ã€‚

### 4.1 æ£€æŸ¥ server/app.js

ç¡®ä¿æœ‰ä»¥ä¸‹ CORS é…ç½®ï¼š

```javascript
const cors = require('cors');

// CORS é…ç½®
app.use(cors({
  origin: [
    'http://localhost:5173',  // æœ¬åœ°å›¢é•¿ç«¯
    'http://localhost:5174',  // æœ¬åœ°å±…æ°‘ç«¯
    'https://your-captain-app.vercel.app',  // ç”Ÿäº§ç¯å¢ƒå›¢é•¿ç«¯
    'https://your-resident-app.vercel.app'  // ç”Ÿäº§ç¯å¢ƒå±…æ°‘ç«¯
  ],
  credentials: true
}));
```

### 4.2 æ›´æ–° CORS é…ç½®

å¦‚æœéœ€è¦å…è®¸æ‰€æœ‰æ¥æºï¼ˆå¼€å‘é˜¶æ®µï¼‰ï¼š

```javascript
app.use(cors({
  origin: '*',
  credentials: true
}));
```

âš ï¸ **å®‰å…¨æç¤º**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®æ˜ç¡®æŒ‡å®šå…è®¸çš„å‰ç«¯åŸŸåï¼Œä¸è¦ä½¿ç”¨ `*`ã€‚

---

## 5. è‡ªåŠ¨éƒ¨ç½²é…ç½®

### 5.1 å¯ç”¨è‡ªåŠ¨éƒ¨ç½²

Render é»˜è®¤å¯ç”¨è‡ªåŠ¨éƒ¨ç½²ï¼Œæ¯æ¬¡æ¨é€ä»£ç åˆ° GitHub éƒ½ä¼šè‡ªåŠ¨è§¦å‘éƒ¨ç½²ã€‚

**éƒ¨ç½²æµç¨‹**ï¼š
```
æœ¬åœ°ä¿®æ”¹ä»£ç  â†’ git push â†’ GitHub â†’ Render è‡ªåŠ¨æ£€æµ‹ â†’ è‡ªåŠ¨éƒ¨ç½²
```

### 5.2 æŸ¥çœ‹éƒ¨ç½²å†å²

1. åœ¨ Render Dashboard ä¸­é€‰æ‹©ä½ çš„æœåŠ¡
2. ç‚¹å‡» "Events" æ ‡ç­¾
3. æŸ¥çœ‹æ‰€æœ‰éƒ¨ç½²è®°å½•å’ŒçŠ¶æ€

### 5.3 æ‰‹åŠ¨éƒ¨ç½²

å¦‚æœéœ€è¦æ‰‹åŠ¨è§¦å‘éƒ¨ç½²ï¼š

1. åœ¨æœåŠ¡è¯¦æƒ…é¡µé¢
2. ç‚¹å‡»å³ä¸Šè§’ "Manual Deploy" æŒ‰é’®
3. é€‰æ‹© "Deploy latest commit"

---

## 6. ç¯å¢ƒç®¡ç†

### 6.1 ä¿®æ”¹ç¯å¢ƒå˜é‡

1. è¿›å…¥æœåŠ¡è¯¦æƒ…é¡µé¢
2. ç‚¹å‡»å·¦ä¾§ "Environment" æ ‡ç­¾
3. æ‰¾åˆ°è¦ä¿®æ”¹çš„ç¯å¢ƒå˜é‡
4. ç‚¹å‡»ç¼–è¾‘æˆ–åˆ é™¤
5. ç‚¹å‡» "Save Changes"
6. **æœåŠ¡ä¼šè‡ªåŠ¨é‡å¯**åº”ç”¨æ–°çš„ç¯å¢ƒå˜é‡

### 6.2 æŸ¥ï¿½ï¿½æœåŠ¡æ—¥å¿—

1. ç‚¹å‡» "Logs" æ ‡ç­¾
2. å®æ—¶æŸ¥çœ‹åº”ç”¨æ—¥å¿—
3. å¯ä»¥ç”¨äºè°ƒè¯•é”™è¯¯

å¸¸ç”¨æ—¥å¿—ç¤ºä¾‹ï¼š
```
Server is running on port 3000
âœ“ MySQL æ•°æ®åº“è¿æ¥æˆåŠŸ
âœ“ MongoDB æ•°æ®åº“è¿æ¥æˆåŠŸ
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 ä¿æŒæœåŠ¡æ´»è·ƒ

å…è´¹ç‰ˆæœåŠ¡åœ¨ 15 åˆ†é’Ÿæ— æ´»åŠ¨åä¼šä¼‘çœ ï¼Œé¦–æ¬¡è®¿é—®éœ€è¦ 30-60 ç§’å”¤é†’ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å®šæ—¶ä»»åŠ¡å®šæœŸè®¿é—® API

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å…è´¹æœåŠ¡ï¼š
- [UptimeRobot](https://uptimerobot.com/) - æ¯ 5 åˆ†é’Ÿ ping ä¸€æ¬¡
- [Cron-job.org](https://cron-job.org/) - è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡

é…ç½®ç¤ºä¾‹ï¼š
```
URL: https://kiro_basket-api.onrender.com/health
é—´éš”: 5 åˆ†é’Ÿ
æ–¹æ³•: GET
```

### 7.2 æ•°æ®åº“è¿æ¥æ± 

ç¡®ä¿ Sequelize å’Œ Mongoose é…ç½®äº†åˆç†çš„è¿æ¥æ± ï¼š

```javascript
// MySQL è¿æ¥æ± é…ç½®
const sequelize = new Sequelize(database, username, password, {
  host,
  dialect: 'mysql',
  pool: {
    max: 5,      // æœ€å¤§è¿æ¥æ•°
    min: 0,      // æœ€å°è¿æ¥æ•°
    acquire: 30000,
    idle: 10000
  }
});

// MongoDB è¿æ¥é…ç½®
mongoose.connect(mongoUri, {
  maxPoolSize: 10,
  minPoolSize: 2
});
```

---

## 8. ç›‘æ§å’Œæ—¥å¿—

### 8.1 å¥åº·æ£€æŸ¥

ç¡®ä¿åº”ç”¨æœ‰å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š

```javascript
// server/app.js
app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});
```

### 8.2 é”™è¯¯ç›‘æ§

å»ºè®®æ·»åŠ é”™è¯¯æ—¥å¿—è®°å½•ï¼š

```javascript
// å…¨å±€é”™è¯¯å¤„ç†
app.use((err, req, res, next) => {
  console.error('Error:', err);
  res.status(500).json({
    code: 500,
    message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
    error: process.env.NODE_ENV === 'development' ? err.message : undefined
  });
});
```

---

## 9. æ•…éšœæ’æŸ¥

### 9.1 éƒ¨ç½²å¤±è´¥

**æŸ¥çœ‹æ„å»ºæ—¥å¿—**ï¼š
- åœ¨ Render Dashboard æŸ¥çœ‹è¯¦ç»†çš„æ„å»ºæ—¥å¿—
- æ£€æŸ¥ npm install æ˜¯å¦æˆåŠŸ
- ç¡®è®¤ package.json ä¸­çš„ä¾èµ–æ­£ç¡®

**å¸¸è§é—®é¢˜**ï¼š
```bash
# é—®é¢˜ï¼šæ‰¾ä¸åˆ°æ¨¡å—
è§£å†³ï¼šç¡®ä¿ package.json åŒ…å«æ‰€æœ‰ä¾èµ–

# é—®é¢˜ï¼šç«¯å£é”™è¯¯
è§£å†³ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ process.env.PORT

# é—®é¢˜ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
è§£å†³ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®æ˜¯å¦æ­£ç¡®
```

### 9.2 æœåŠ¡è¿è¡Œå¼‚å¸¸

**æŸ¥çœ‹è¿è¡Œæ—¥å¿—**ï¼š
- ç‚¹å‡» "Logs" æ ‡ç­¾
- æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯

**é‡å¯æœåŠ¡**ï¼š
1. ç‚¹å‡»å³ä¸Šè§’ "Manual Deploy"
2. é€‰æ‹© "Clear build cache & deploy"

### 9.3 æ•°æ®åº“è¿æ¥é—®é¢˜

æ£€æŸ¥ä»¥ä¸‹äº‹é¡¹ï¼š
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] MySQL å¯†ç ä¸­çš„ç‰¹æ®Šå­—ç¬¦æ˜¯å¦éœ€è¦è½¬ä¹‰
- [ ] MongoDB Atlas IP ç™½åå•åŒ…å« `0.0.0.0/0`
- [ ] æ•°æ®åº“ç”¨æˆ·æƒé™æ­£ç¡®

---

## 10. å®‰å…¨å»ºè®®

### 10.1 ç¯å¢ƒå˜é‡å®‰å…¨

- âœ… ä½¿ç”¨ Render çš„ç¯å¢ƒå˜é‡åŠŸèƒ½ï¼Œä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
- âœ… ä¸ºç”Ÿäº§ç¯å¢ƒç”Ÿæˆå¼ºéšæœºçš„ JWT_SECRET
- âœ… ä¸è¦åœ¨ Git æäº¤ `.env` æ–‡ä»¶

### 10.2 CORS é…ç½®

ç”Ÿäº§ç¯å¢ƒæ˜ç¡®æŒ‡å®šå…è®¸çš„åŸŸåï¼š

```javascript
const allowedOrigins = [
  'https://your-captain-app.vercel.app',
  'https://your-resident-app.vercel.app'
];

app.use(cors({
  origin: function(origin, callback) {
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true
}));
```

### 10.3 API é™æµ

å»ºè®®æ·»åŠ è¯·æ±‚é™æµä¸­é—´ä»¶ï¼ˆexpress-rate-limitï¼‰ï¼š

```bash
npm install express-rate-limit
```

```javascript
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 åˆ†é’Ÿ
  max: 100 // é™åˆ¶ 100 ä¸ªè¯·æ±‚
});

app.use('/api', limiter);
```

---

## 11. é…ç½®ä¿¡æ¯æ±‡æ€»

å®Œæˆéƒ¨ç½²åï¼Œè®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š

```
åç«¯ API åœ°å€: https://________________.onrender.com
å¥åº·æ£€æŸ¥: https://________________.onrender.com/health
API åŸºç¡€è·¯å¾„: https://________________.onrender.com/api
```
