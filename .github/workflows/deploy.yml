name: Deploy to Vercel and Render

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡ï¼ˆå¯åœ¨ GitHub Secrets ä¸­é…ç½®ï¼‰
env:
  NODE_VERSION: '18'

jobs:
  # æ£€æµ‹å˜æ›´çš„ç›®å½•
  detect-changes:
    name: æ£€æµ‹å˜æ›´
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.changes.outputs.server }}
      captain: ${{ steps.changes.outputs.captain }}
      resident: ${{ steps.changes.outputs.resident }}
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æµ‹æ–‡ä»¶å˜æ›´
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            server:
              - 'server/**'
            captain:
              - 'client-captain/**'
            resident:
              - 'client-resident/**'

  # éƒ¨ç½²åç«¯åˆ° Render
  deploy-server:
    name: éƒ¨ç½²åç«¯ (Render)
    needs: detect-changes
    if: needs.detect-changes.outputs.server == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è§¦å‘ Render éƒ¨ç½²
        run: |
          echo "ğŸš€ è§¦å‘ Render éƒ¨ç½²..."
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
            echo "âœ… Render éƒ¨ç½²å·²è§¦å‘"
          else
            echo "âš ï¸  æœªé…ç½® RENDER_DEPLOY_HOOK_URLï¼Œè·³è¿‡éƒ¨ç½²"
            echo "è¯·åœ¨ GitHub Secrets ä¸­æ·»åŠ  Render Deploy Hook URL"
          fi

  # éƒ¨ç½²å›¢é•¿ç«¯åˆ° Vercel
  deploy-captain:
    name: éƒ¨ç½²å›¢é•¿ç«¯ (Vercel)
    needs: detect-changes
    if: needs.detect-changes.outputs.captain == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Vercel CLI
        run: npm install -g vercel

      - name: æ‹‰å– Vercel ç¯å¢ƒä¿¡æ¯
        run: |
          cd client-captain
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: æ„å»ºé¡¹ç›®
        run: |
          cd client-captain
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: éƒ¨ç½²åˆ° Vercel
        run: |
          cd client-captain
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_CAPTAIN_PROJECT_ID }}

  # éƒ¨ç½²å±…æ°‘ç«¯åˆ° Vercel
  deploy-resident:
    name: éƒ¨ç½²å±…æ°‘ç«¯ (Vercel)
    needs: detect-changes
    if: needs.detect-changes.outputs.resident == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Vercel CLI
        run: npm install -g vercel

      - name: æ‹‰å– Vercel ç¯å¢ƒä¿¡æ¯
        run: |
          cd client-resident
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: æ„å»ºé¡¹ç›®
        run: |
          cd client-resident
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: éƒ¨ç½²åˆ° Vercel
        run: |
          cd client-resident
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_RESIDENT_PROJECT_ID }}

  # éƒ¨ç½²å®Œæˆé€šçŸ¥
  notify:
    name: éƒ¨ç½²é€šçŸ¥
    needs: [deploy-server, deploy-captain, deploy-resident]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        run: |
          echo "ğŸ“Š éƒ¨ç½²æŠ¥å‘Š"
          echo "============================================"
          echo "åç«¯ (Render):    ${{ needs.deploy-server.result }}"
          echo "å›¢é•¿ç«¯ (Vercel):  ${{ needs.deploy-captain.result }}"
          echo "å±…æ°‘ç«¯ (Vercel):  ${{ needs.deploy-resident.result }}"
          echo "============================================"

          if [ "${{ needs.deploy-server.result }}" == "failure" ] ||
             [ "${{ needs.deploy-captain.result }}" == "failure" ] ||
             [ "${{ needs.deploy-resident.result }}" == "failure" ]; then
            echo "âŒ éƒ¨åˆ†éƒ¨ç½²å¤±è´¥"
            exit 1
          else
            echo "âœ… æ‰€æœ‰éƒ¨ç½²æˆåŠŸ"
          fi
